<script>
// ✅ Dynamic API base
const API_BASE = window.location.hostname === "localhost"
  ? "http://localhost:5000"
  : "https://jobsarena.onrender.com";

// ===== Session guard =====
const session = JSON.parse(localStorage.getItem('jb_session')||'null');
if(!session){ alert('Please login'); window.location='login.html'; }
document.getElementById('welcome').innerHTML = '<div style="font-weight:800">Welcome, '+session.name+'</div><div style="color:var(--muted)">Role: '+session.role+'</div>';
if(session.role!=='admin') document.getElementById('adminLink').style.display='none';

// ===== Logout =====
document.getElementById('logoutBtn').addEventListener('click', ()=>{ 
  localStorage.removeItem('jb_session'); 
  window.location='index.html'; 
});

// ===== Tabs =====
const panel = document.getElementById('panel');
const tabs = document.querySelectorAll('.tabBtn');
let activeTab = 'jobs', prevJobs=[], prevMembers=[], prevOffers=[];

// ✅ Missing function to activate tab
function activateTab(tab){
  activeTab = tab;
  if(tab === 'jobs') renderJobsTab();
  if(tab === 'members') renderMembersTab();
  if(tab === 'offers') renderOffersTab();
}

tabs.forEach(t=>t.addEventListener('click', ()=>activateTab(t.dataset.tab)));

// Load first tab immediately
activateTab(activeTab);
// Refresh every 5s
setInterval(()=> activateTab(activeTab), 5000);

// ===== Render Jobs =====
async function renderJobsTab(){
  try{
    const res = await fetch(`${API_BASE}/api/jobs`);
    const jobs = await res.json();
    panel.innerHTML = '<h3>Available Jobs</h3>';
    const grid = document.createElement('div'); grid.className='jobs-grid';
    jobs.forEach(j=>{
      const card = document.createElement('div'); card.className='job-card';
      card.innerHTML = `<div style="font-weight:800">${j.title}</div>
        <div style="color:var(--muted)">${j.company} • ${j.location}</div>
        <div style="margin-top:8px"><span class="badge">${j.category}</span></div>`;
      card.onclick = ()=> window.location='job.html?id='+j.id;
      if(!prevJobs.find(p=>p.id===j.id)) card.classList.add('flash');
      grid.appendChild(card);
    });
    panel.appendChild(grid);
    prevJobs = jobs;
  }catch(err){ console.error(err); panel.innerHTML='<p>Failed to load jobs</p>'; }
}

// ===== Render Members =====
async function renderMembersTab(){
  try{
    const res = await fetch(`${API_BASE}/api/members`);
    const members = await res.json();
    panel.innerHTML = '<h3>Members</h3>';
    const grid = document.createElement('div'); grid.className='members-grid';
    members.forEach(m=>{
      const card = document.createElement('div'); card.className='member-card';
      card.innerHTML = `<strong>${m.name}</strong> <span style="color:var(--muted)">— ${m.role||'member'}</span>`;
      if(!prevMembers.find(p=>p.id===m.id)) card.classList.add('flash');
      grid.appendChild(card);
    });
    panel.appendChild(grid);
    prevMembers = members;
  }catch(err){ console.error(err); panel.innerHTML='<p>Failed to load members</p>'; }
}

// ===== Render Offers =====
async function renderOffersTab(){
  try{
    const res = await fetch(`${API_BASE}/api/offers`);
    const offers = await res.json();
    panel.innerHTML = '<h3>Offers</h3>';
    const grid = document.createElement('div'); grid.className='offers-grid';
    offers.forEach(o=>{
      const card = document.createElement('div'); card.className='offer-card';
      card.innerHTML = `<div style="font-weight:800">${o.title}</div>
        <div style="color:var(--muted)">${o.description}</div>
        <div style="margin-top:8px"><strong>Price:</strong> ${o.price}</div>`;
      if(!prevOffers.find(p=>p.id===o.id)) card.classList.add('flash');
      grid.appendChild(card);
    });
    panel.appendChild(grid);
    prevOffers = offers;
  }catch(err){ console.error(err); panel.innerHTML='<p>Failed to load offers</p>'; }
}
</script>

